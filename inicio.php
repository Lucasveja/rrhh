<?php ini_set('display_errors', 1); ini_set('display_startup_errors', 1); error_reporting(E_ALL); session_start(); include("conexionn/conexion.php"); include("Funciones_Turno.php"); // Guard de sesiÃ³n (Admin o Evaluador) if ( !isset($_SESSION['uid']) || (!isset($_SESSION['autenticado']) && !isset($_SESSION['Evaluador'])) ) { header("Location: index.php"); exit; } // Intentar datos de Admin (si corresponde) $nombreUsuario = ""; if (!empty($_SESSION['autenticado'])) { $uidEsc = mysqli_real_escape_string($conexion, $_SESSION['uid']); $sql = "SELECT tx_nombre, tx_apellido FROM t_usuarios WHERE id_dni = '{$uidEsc}'"; $result = mysqli_query($conexion, $sql); if ($fila = mysqli_fetch_assoc($result)) { $nombreUsuario = trim(($fila['tx_nombre'] ?? '') . " " . ($fila['tx_apellido'] ?? '')); } } // Inicializaciones $isEvaluador = false; $porcentaje = 0; $p = 0; // Si es Evaluador, calcular progreso if (!empty($_SESSION['Evaluador'])) { $uidEsc = mysqli_real_escape_string($conexion, $_SESSION['uid']); $sqlEv = "SELECT * FROM evaluador WHERE Id = '{$uidEsc}'"; $resEv = mysqli_query($conexion, $sqlEv); if ($resEv && mysqli_num_rows($resEv) > 0) { $evaluador = mysqli_fetch_array($resEv); $sqlP = "SELECT Periodo FROM periodos WHERE PeriodoActivo = 1 LIMIT 1"; $resP = mysqli_query($conexion, $sqlP); $periodo = mysqli_fetch_array($resP); $sqlAs = "SELECT COUNT(*) AS c FROM asignados WHERE IdEvaluador = '{$uidEsc}' AND Periodo = '{$periodo['Periodo']}' AND IdEmpresa = '{$evaluador['IdEmpresa']}'"; $resAs = mysqli_query($conexion, $sqlAs); $rowAs = mysqli_fetch_assoc($resAs); $nAs = (int)($rowAs['c'] ?? 0); $sqlMov = "SELECT COUNT(DISTINCT IdEvaluado) AS c FROM movimientos WHERE idEvaluador = '{$uidEsc}' AND IdEmpresa = '{$evaluador['IdEmpresa']}' AND Periodo = '{$periodo['Periodo']}'"; $resMov = mysqli_query($conexion, $sqlMov); $rowMov = mysqli_fetch_assoc($resMov); $nMov = (int)($rowMov['c'] ?? 0); $porcentaje = ($nAs > 0) ? ($nMov * 100 / $nAs) : 0; $p = number_format($porcentaje, 2, '.', ''); $isEvaluador = true; } } ?> <!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Bienvenidoss</title> <link href="style.css" rel="stylesheet" type="text/css" media="screen" /> <link href="CSS/bootstrap.min.css" rel="stylesheet" type="text/css" media="screen" /> <link href="CSS/sticky-footer-navbar.css" rel="stylesheet" type="text/css" media="screen" /> <link href="CSS/fonts.css" rel="stylesheet" type="text/css" media="screen" /> <script src="js/jquery.min.js"></script> <script src="js/bootstrap.min.js"></script> <script type="text/javascript" src="jalert/jquery.alerts.js"></script> <link href="jalert/jquery.alerts.css" rel="stylesheet" type="text/css" /> <script src="js/jquery.validate.js" type="text/javascript"></script> <script src="js/messages_es.js" type="text/javascript"></script> </head> <body> <div class="container-fluid"> <header id="header"> <div class="row"> <?php include("Menu/Menu_Bootstrap.php"); ?> </div> </header> </div> <div class="container"> <!-- Contenido central --> </div> <?php if ($isEvaluador && $porcentaje != 100) { ?> <div class="col-sm-3 col-sm-offset-9"> <div class="panel panel-primary"> <div class="panel-heading"> <h3 class="panel-title">Personas que faltan evaluar:</h3> </div> <?php $sql = "SELECT * FROM asignados INNER JOIN evaluado ON asignados.idevaluado = evaluado.id WHERE idevaluador = '{$_SESSION['uid']}' AND periodo = '{$periodo['Periodo']}' AND NOT EXISTS ( SELECT * FROM movimientos WHERE movimientos.idevaluado = asignados.idevaluado AND movimientos.idevaluador = '{$_SESSION['uid']}' AND movimientos.periodo = '{$periodo['Periodo']}' ) AND evaluado.baja IS NULL"; $res = mysqli_query($conexion, $sql); while ($row = mysqli_fetch_array($res)) { echo "<div class='panel-body'>" . htmlspecialchars($row['Nombre']) . "</div>"; } ?> </div> </div> <?php } ?> <footer class="footer"> <div class="container"> <div> <span>Bienvenido: <strong><?php echo htmlspecialchars($isEvaluador ? ($evaluador['Nombre'] ?? '') : $nombreUsuario); ?></strong></span> </div> <div class="col-sm-12"> <span>Llevas un total de Cargas de Evaluaciones: </span> <div class="progress"> <div class="progress-bar" role="progressbar" aria-valuenow="<?php echo $p; ?>" aria-valuemin="0" aria-valuemax="100" style="width:<?php echo $p; ?>%;"> <strong><?php echo number_format($p, 2, ',', '') . "%"; ?></strong> </div> </div> </div> </div> </footer> </body> </html>